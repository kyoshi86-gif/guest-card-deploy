import"./modulepreload-polyfill-B5Qt9EMX.js";import{c as X,l as q,s as k}from"./base-B22LZU_k.js";import"https://esm.sh/@supabase/supabase-js";X();document.getElementById("logout").onclick=q;document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelector("#dataTable tbody"),d=document.getElementById("selectAll"),b=document.getElementById("filterBtn"),S=document.getElementById("exportBtn"),g=document.getElementById("saveBtn"),L=document.getElementById("resetBtn"),f=document.getElementById("filterStart"),_=document.getElementById("filterEnd"),E=document.getElementById("uploadExcel");let o=[];function B(n){return n?new Date(n).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"}):""}function p(){if(!o||o.length===0){g&&(g.style.display="none");return}const n=o.some(a=>!!a._checked!=!!a.is_saved);g&&(g.style.display=n?"inline-block":"none")}function A(n){if(!m)return;m.innerHTML="";const a=["food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating"];n.forEach((e,t)=>{const s=document.createElement("tr"),c=document.createElement("td");c.style.textAlign="center";const l=document.createElement("input");l.type="checkbox",l.dataset.index=t,l.checked=e._checked,e.is_saved&&s.classList.add("table-success"),l.addEventListener("change",r=>{e._checked=r.target.checked,r.target.checked?s.classList.add("table-success"):e.is_saved||s.classList.remove("table-success"),p()}),c.appendChild(l),s.appendChild(c),["tgl","jam","no_meja","nama_tamu","asal","kunjungan_pertama","media_source","media_other","event_type","event_other","age_range","food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating","comments"].forEach(r=>{const u=document.createElement("td");u.style.whiteSpace="normal",u.style.textAlign="center";let h=e[r]??"";r==="tgl"&&e[r]&&(h=B(e[r])),u.textContent=h,a.includes(r)&&(String(h).trim()==="1"||String(h).trim()==="2")&&(u.style.backgroundColor="red",u.style.color="white",u.style.fontWeight="bold"),s.appendChild(u)}),m.appendChild(s)}),w(),p()}function w(){if(!d||!m)return;const n=Array.from(m.querySelectorAll("input[type=checkbox]")),a=n.filter(e=>e.checked).length;a===0?(d.checked=!1,d.indeterminate=!1):a===n.length?(d.checked=!0,d.indeterminate=!1):(d.checked=!1,d.indeterminate=!0)}async function y(n,a){let e=k.from("guest_comments").select("*");if(n&&a)e=e.gte("tgl",n.toISOString()).lte("tgl",a.toISOString());else{const c=new Date,l=new Date(c.getFullYear(),c.getMonth(),2),v=new Date(c.getFullYear(),c.getMonth()+1,0);f&&(f.valueAsDate=l),_&&(_.valueAsDate=v),e=e.gte("tgl",l.toISOString()).lte("tgl",v.toISOString())}e=e.order("tgl",{ascending:!0});const{data:t,error:s}=await e;if(s){console.error(s),alert("Gagal memuat data");return}o=(t||[]).map(c=>(c._checked=c.is_saved===!0,c)),A(o),p()}g&&g.addEventListener("click",async()=>{const n=m.querySelectorAll("tr");o.forEach((e,t)=>{const s=n[t];if(!s)return;const c=s.querySelector("input[type=checkbox]"),l=c?c.checked:!!e.is_saved;e._checked=l,e.is_saved=l,l?s.classList.add("table-success"):s.classList.remove("table-success")}),w(),p();const a=o.map(e=>k.from("guest_comments").update({is_saved:e.is_saved}).eq("id",e.id).then(({error:t})=>{t&&console.error("Update gagal untuk id:",e.id,t)}));Promise.all(a).then(()=>{console.log("Update selesai"),alert("Perubahan disimpan")}).catch(e=>{console.error("Error update:",e),alert("Terjadi kesalahan saat menyimpan perubahan")})}),b&&b.addEventListener("click",()=>{const n=f?.value||"",a=_?.value||"";if(n&&a){const e=new Date(n),t=new Date(a);if(t<e){alert("Tanggal akhir tidak boleh lebih kecil dari tanggal mulai.");return}y(e,t)}else y()}),d&&d.addEventListener("change",n=>{const a=n.target.checked;o.forEach((e,t)=>{e._checked=a;const s=m.children[t];if(!s)return;const c=s.querySelector("input[type=checkbox]");c&&(c.checked=a),a?s.classList.add("table-success"):e.is_saved||s.classList.remove("table-success")}),p()}),L&&L.addEventListener("click",()=>{f&&(f.value=""),_&&(_.value=""),y()}),S&&S.addEventListener("click",()=>{if(typeof XLSX>"u"){alert("Library XLSX tidak ditemukan.");return}const n=[["Tanggal","Jam","No Meja","Nama","Asal","Kunjungan Pertama","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],...o.map(t=>[B(t.tgl),t.jam??"",t.no_meja??"",t.nama_tamu??"",t.asal??"",t.kunjungan_pertama??"",t.media_source??"",t.media_other??"",t.event_type??"",t.event_other??"",t.age_range??"",t.food_quality??"",t.beverage_quality??"",t.serving_speed??"",t.service_rating??"",t.cleanliness??"",t.ambience??"",t.price_rating??"",t.comments??""])],a=XLSX.utils.aoa_to_sheet(n),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,a,"Guest Comments"),XLSX.writeFile(e,"guest_comments.xlsx")}),E&&E.addEventListener("change",I);async function I(n){const a=n.target.files[0];if(!a)return;const e=new FileReader;e.onload=async function(t){try{const s=new Uint8Array(t.target.result),c=XLSX.read(s,{type:"array"}),l=c.SheetNames[0],v=c.Sheets[l],r=XLSX.utils.sheet_to_json(v,{header:1}),u=["Tanggal","Jam","No Meja","Nama","Asal","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],h=r[0]||[];if(!u.every((i,C)=>h[C]===i)){alert("Format header tidak sesuai");return}const D=r.slice(1).map(i=>({tgl:i[0]?new Date(i[0]):null,jam:i[1]??"",no_meja:i[2]??"",nama_tamu:i[3]??"",asal:i[4]??"",media_source:i[5]??"",media_other:i[6]??"",event_type:i[7]??"",service_other:i[8]??"",age_range:i[9]??"",food_quality:i[10]??"",beverage_quality:i[11]??"",serving_speed:i[12]??"",service_rating:i[13]??"",cleanliness:i[14]??"",ambience:i[15]??"",price_rating:i[16]??"",comments:i[17]??""})),{error:x}=await k.from("guest_comments").insert(D);x?(console.error(x),alert("Upload gagal")):(alert("Upload berhasil!"),y())}catch(s){console.error(s),alert("Gagal membaca file Excel")}},e.readAsArrayBuffer(a)}k.channel("guest_comments_channel").on("postgres_changes",{event:"*",schema:"public",table:"guest_comments"},n=>{const a=n.new;if(!a)return;const e=o.findIndex(t=>t.id===a.id);e>=0&&(o[e].is_saved=a.is_saved,o[e]._checked=a.is_saved,A(o))}).subscribe(),y()});
