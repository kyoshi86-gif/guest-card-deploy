import"./modulepreload-polyfill-B5Qt9EMX.js";import{c as X,l as q,s as b}from"./base-BoAYqK8R.js";import"https://esm.sh/@supabase/supabase-js";X();document.getElementById("logout").onclick=q;document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelector("#dataTable tbody"),r=document.getElementById("selectAll"),k=document.getElementById("filterBtn"),S=document.getElementById("exportBtn"),g=document.getElementById("saveBtn"),L=document.getElementById("resetBtn"),y=document.getElementById("filterStart"),p=document.getElementById("filterEnd"),E=document.getElementById("uploadExcel");let o=[];function B(n){return n?new Date(n).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"}):""}function f(){if(!o||o.length===0){g&&(g.style.display="none");return}const n=o.some(t=>!!t._checked!=!!t.is_saved);g&&(g.style.display=n?"inline-block":"none")}function w(n){if(!m)return;m.innerHTML="";const t=["food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating"];n.forEach((e,a)=>{const c=document.createElement("tr"),s=document.createElement("td");s.style.textAlign="center";const d=document.createElement("input");d.type="checkbox",d.dataset.index=a,d.checked=e._checked,e.is_saved&&c.classList.add("table-success"),d.addEventListener("change",l=>{e._checked=l.target.checked,l.target.checked?c.classList.add("table-success"):e.is_saved||c.classList.remove("table-success"),f()}),s.appendChild(d),c.appendChild(s),["tgl","jam","no_meja","nama_tamu","asal","media_source","media_other","event_type","event_other","age_range","food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating","comments"].forEach(l=>{const u=document.createElement("td");u.style.whiteSpace="normal",u.style.textAlign="center";let h=e[l]??"";l==="tgl"&&e[l]&&(h=B(e[l])),u.textContent=h,t.includes(l)&&(String(h).trim()==="1"||String(h).trim()==="2")&&(u.style.backgroundColor="red",u.style.color="white",u.style.fontWeight="bold"),c.appendChild(u)}),m.appendChild(c)}),A(),f()}function A(){if(!r||!m)return;const n=Array.from(m.querySelectorAll("input[type=checkbox]")),t=n.filter(e=>e.checked).length;t===0?(r.checked=!1,r.indeterminate=!1):t===n.length?(r.checked=!0,r.indeterminate=!1):(r.checked=!1,r.indeterminate=!0)}async function _(n,t){let e=b.from("guest_comments").select("*");if(n&&t)e=e.gte("tgl",n.toISOString()).lte("tgl",t.toISOString());else{const s=new Date,d=new Date(s.getFullYear(),s.getMonth(),1),v=new Date(s.getFullYear(),s.getMonth()+1,0);e=e.gte("tgl",d.toISOString()).lte("tgl",v.toISOString())}e=e.order("tgl",{ascending:!0});const{data:a,error:c}=await e;if(c){console.error(c),alert("Gagal memuat data");return}o=(a||[]).map(s=>(s._checked=s.is_saved===!0,s)),w(o),f()}g&&g.addEventListener("click",async()=>{const n=m.querySelectorAll("tr");o.forEach((t,e)=>{const a=n[e];if(!a)return;const c=a.querySelector("input[type=checkbox]"),s=c?c.checked:!!t.is_saved;t._checked=s,t.is_saved=s,s?a.classList.add("table-success"):a.classList.remove("table-success")}),A(),f();for(const t of o){const{error:e}=await b.from("guest_comments").update({is_saved:t.is_saved}).eq("id",t.id);e&&console.error("Update gagal untuk id:",t.id,e)}alert("Perubahan disimpan"),console.log("Update selesai")}),k&&k.addEventListener("click",()=>{const n=y?y.value:"",t=p?p.value:"";if(n&&t){const e=new Date(n),a=new Date(t);if(a<e){alert("Tanggal akhir tidak boleh lebih kecil dari tanggal mulai.");return}_(e,a)}else _()}),r&&r.addEventListener("change",n=>{const t=n.target.checked;o.forEach((e,a)=>{e._checked=t;const c=m.children[a];if(!c)return;const s=c.querySelector("input[type=checkbox]");s&&(s.checked=t),t?c.classList.add("table-success"):e.is_saved||c.classList.remove("table-success")}),f()}),L&&L.addEventListener("click",()=>{y&&(y.value=""),p&&(p.value=""),_()}),S&&S.addEventListener("click",()=>{if(typeof XLSX>"u"){alert("Library XLSX tidak ditemukan.");return}const n=[["Tanggal","Jam","No Meja","Nama","Asal","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],...o.map(a=>[B(a.tgl),a.jam??"",a.no_meja??"",a.nama_tamu??"",a.asal??"",a.media_source??"",a.media_other??"",a.event_type??"",a.event_other??"",a.age_range??"",a.food_quality??"",a.beverage_quality??"",a.serving_speed??"",a.service_rating??"",a.cleanliness??"",a.ambience??"",a.price_rating??"",a.comments??""])],t=XLSX.utils.aoa_to_sheet(n),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,t,"Guest Comments"),XLSX.writeFile(e,"guest_comments.xlsx")}),E&&E.addEventListener("change",I);async function I(n){const t=n.target.files[0];if(!t)return;const e=new FileReader;e.onload=async function(a){try{const c=new Uint8Array(a.target.result),s=XLSX.read(c,{type:"array"}),d=s.SheetNames[0],v=s.Sheets[d],l=XLSX.utils.sheet_to_json(v,{header:1}),u=["Tanggal","Jam","No Meja","Nama","Asal","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],h=l[0]||[];if(!u.every((i,D)=>h[D]===i)){alert("Format header tidak sesuai");return}const C=l.slice(1).map(i=>({tgl:i[0]?new Date(i[0]):null,jam:i[1]??"",no_meja:i[2]??"",nama_tamu:i[3]??"",asal:i[4]??"",media_source:i[5]??"",media_other:i[6]??"",event_type:i[7]??"",service_other:i[8]??"",age_range:i[9]??"",food_quality:i[10]??"",beverage_quality:i[11]??"",serving_speed:i[12]??"",service_rating:i[13]??"",cleanliness:i[14]??"",ambience:i[15]??"",price_rating:i[16]??"",comments:i[17]??""})),{error:x}=await b.from("guest_comments").insert(C);x?(console.error(x),alert("Upload gagal")):(alert("Upload berhasil!"),_())}catch(c){console.error(c),alert("Gagal membaca file Excel")}},e.readAsArrayBuffer(t)}b.channel("guest_comments_channel").on("postgres_changes",{event:"*",schema:"public",table:"guest_comments"},n=>{const t=n.new;if(!t)return;const e=o.findIndex(a=>a.id===t.id);e>=0&&(o[e].is_saved=t.is_saved,o[e]._checked=t.is_saved,w(o))}).subscribe(),_()});
