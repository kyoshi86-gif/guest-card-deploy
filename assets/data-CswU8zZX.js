import"./modulepreload-polyfill-B5Qt9EMX.js";import{c as X,l as q,s as b}from"./base-B22LZU_k.js";import"https://esm.sh/@supabase/supabase-js";X();document.getElementById("logout").onclick=q;document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelector("#dataTable tbody"),d=document.getElementById("selectAll"),k=document.getElementById("filterBtn"),S=document.getElementById("exportBtn"),g=document.getElementById("saveBtn"),L=document.getElementById("resetBtn"),y=document.getElementById("filterStart"),p=document.getElementById("filterEnd"),E=document.getElementById("uploadExcel");let l=[];function B(n){return n?new Date(n).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"}):""}function f(){if(!l||l.length===0){g&&(g.style.display="none");return}const n=l.some(a=>!!a._checked!=!!a.is_saved);g&&(g.style.display=n?"inline-block":"none")}function w(n){if(!m)return;m.innerHTML="";const a=["food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating"];n.forEach((e,t)=>{const s=document.createElement("tr"),c=document.createElement("td");c.style.textAlign="center";const o=document.createElement("input");o.type="checkbox",o.dataset.index=t,o.checked=e._checked,e.is_saved&&s.classList.add("table-success"),o.addEventListener("change",r=>{e._checked=r.target.checked,r.target.checked?s.classList.add("table-success"):e.is_saved||s.classList.remove("table-success"),f()}),c.appendChild(o),s.appendChild(c),["tgl","jam","no_meja","nama_tamu","asal","media_source","media_other","event_type","event_other","age_range","food_quality","beverage_quality","serving_speed","service_rating","cleanliness","ambience","price_rating","comments"].forEach(r=>{const u=document.createElement("td");u.style.whiteSpace="normal",u.style.textAlign="center";let h=e[r]??"";r==="tgl"&&e[r]&&(h=B(e[r])),u.textContent=h,a.includes(r)&&(String(h).trim()==="1"||String(h).trim()==="2")&&(u.style.backgroundColor="red",u.style.color="white",u.style.fontWeight="bold"),s.appendChild(u)}),m.appendChild(s)}),A(),f()}function A(){if(!d||!m)return;const n=Array.from(m.querySelectorAll("input[type=checkbox]")),a=n.filter(e=>e.checked).length;a===0?(d.checked=!1,d.indeterminate=!1):a===n.length?(d.checked=!0,d.indeterminate=!1):(d.checked=!1,d.indeterminate=!0)}async function _(n,a){let e=b.from("guest_comments").select("*");if(n&&a)e=e.gte("tgl",n.toISOString()).lte("tgl",a.toISOString());else{const c=new Date,o=new Date(c.getFullYear(),c.getMonth(),1),v=new Date(c.getFullYear(),c.getMonth()+1,0);e=e.gte("tgl",o.toISOString()).lte("tgl",v.toISOString())}e=e.order("tgl",{ascending:!0});const{data:t,error:s}=await e;if(s){console.error(s),alert("Gagal memuat data");return}l=(t||[]).map(c=>(c._checked=c.is_saved===!0,c)),w(l),f()}g&&g.addEventListener("click",async()=>{const n=m.querySelectorAll("tr");l.forEach((e,t)=>{const s=n[t];if(!s)return;const c=s.querySelector("input[type=checkbox]"),o=c?c.checked:!!e.is_saved;e._checked=o,e.is_saved=o,o?s.classList.add("table-success"):s.classList.remove("table-success")}),A(),f();const a=l.map(e=>b.from("guest_comments").update({is_saved:e.is_saved}).eq("id",e.id).then(({error:t})=>{t&&console.error("Update gagal untuk id:",e.id,t)}));Promise.all(a).then(()=>{console.log("Update selesai"),alert("Perubahan disimpan")}).catch(e=>{console.error("Error update:",e),alert("Terjadi kesalahan saat menyimpan perubahan")})}),k&&k.addEventListener("click",()=>{const n=y?y.value:"",a=p?p.value:"";if(n&&a){const e=new Date(n),t=new Date(a);if(t<e){alert("Tanggal akhir tidak boleh lebih kecil dari tanggal mulai.");return}_(e,t)}else _()}),d&&d.addEventListener("change",n=>{const a=n.target.checked;l.forEach((e,t)=>{e._checked=a;const s=m.children[t];if(!s)return;const c=s.querySelector("input[type=checkbox]");c&&(c.checked=a),a?s.classList.add("table-success"):e.is_saved||s.classList.remove("table-success")}),f()}),L&&L.addEventListener("click",()=>{y&&(y.value=""),p&&(p.value=""),_()}),S&&S.addEventListener("click",()=>{if(typeof XLSX>"u"){alert("Library XLSX tidak ditemukan.");return}const n=[["Tanggal","Jam","No Meja","Nama","Asal","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],...l.map(t=>[B(t.tgl),t.jam??"",t.no_meja??"",t.nama_tamu??"",t.asal??"",t.media_source??"",t.media_other??"",t.event_type??"",t.event_other??"",t.age_range??"",t.food_quality??"",t.beverage_quality??"",t.serving_speed??"",t.service_rating??"",t.cleanliness??"",t.ambience??"",t.price_rating??"",t.comments??""])],a=XLSX.utils.aoa_to_sheet(n),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,a,"Guest Comments"),XLSX.writeFile(e,"guest_comments.xlsx")}),E&&E.addEventListener("change",I);async function I(n){const a=n.target.files[0];if(!a)return;const e=new FileReader;e.onload=async function(t){try{const s=new Uint8Array(t.target.result),c=XLSX.read(s,{type:"array"}),o=c.SheetNames[0],v=c.Sheets[o],r=XLSX.utils.sheet_to_json(v,{header:1}),u=["Tanggal","Jam","No Meja","Nama","Asal","Media Sosial","Media Lainnya","Acara","Acara Lainnya","Usia","Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price","Comments"],h=r[0]||[];if(!u.every((i,D)=>h[D]===i)){alert("Format header tidak sesuai");return}const C=r.slice(1).map(i=>({tgl:i[0]?new Date(i[0]):null,jam:i[1]??"",no_meja:i[2]??"",nama_tamu:i[3]??"",asal:i[4]??"",media_source:i[5]??"",media_other:i[6]??"",event_type:i[7]??"",service_other:i[8]??"",age_range:i[9]??"",food_quality:i[10]??"",beverage_quality:i[11]??"",serving_speed:i[12]??"",service_rating:i[13]??"",cleanliness:i[14]??"",ambience:i[15]??"",price_rating:i[16]??"",comments:i[17]??""})),{error:x}=await b.from("guest_comments").insert(C);x?(console.error(x),alert("Upload gagal")):(alert("Upload berhasil!"),_())}catch(s){console.error(s),alert("Gagal membaca file Excel")}},e.readAsArrayBuffer(a)}b.channel("guest_comments_channel").on("postgres_changes",{event:"*",schema:"public",table:"guest_comments"},n=>{const a=n.new;if(!a)return;const e=l.findIndex(t=>t.id===a.id);e>=0&&(l[e].is_saved=a.is_saved,l[e]._checked=a.is_saved,w(l))}).subscribe(),_()});
