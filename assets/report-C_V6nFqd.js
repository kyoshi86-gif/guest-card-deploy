import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{c as N,l as P,s as h}from"./base-B22LZU_k.js";import"https://esm.sh/@supabase/supabase-js";N();document.getElementById("logout").onclick=P;const w=["#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ac"],O=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],Y={id:"outlabelsPlugin",afterDraw(e){if(e.config.type!=="pie"&&e.config.type!=="doughnut")return;const t=e.ctx,n=e.data.datasets[0]||{data:[]},o=e.getDatasetMeta(0),l=(n.data||[]).reduce((a,s)=>a+(s||0),0);!o||!o.data||o.data.forEach((a,s)=>{const i=n.data[s]||0;if(i===0)return;const r=a.startAngle,c=a.endAngle,g=(r+c)/2,E=a.x,m=a.y,f=a.outerRadius||Math.min(e.width,e.height)/2,v=E+Math.cos(g)*(f*.9),T=m+Math.sin(g)*(f*.9),x=E+Math.cos(g)*(f+18),B=m+Math.sin(g)*(f+18),I=Math.cos(g)>=0,A=x+(I?8:-8),C=B+4;t.save(),t.strokeStyle="#333",t.lineWidth=1,t.beginPath(),t.moveTo(v,T),t.lineTo(x,B),t.stroke(),t.fillStyle="#333",t.beginPath(),t.arc(x,B,2.5,0,Math.PI*2),t.fill();const F=e.data.labels[s]??"Lainnya",L=l?(i/l*100).toFixed(1):"0.0";t.font="12px Arial",t.fillStyle="#111",t.textAlign=I?"left":"right",t.fillText(`${F} â€” ${i}`,A,C),t.fillText(`(${L}%)`,A,C+14),t.restore()})}},G={id:"barLabelPlugin",afterDatasetsDraw(e){if(e.config.type!=="bar")return;const t=e.ctx;e.data.datasets.forEach(n=>{e.getDatasetMeta(0).data.forEach((l,a)=>{const s=n.data[a];if(s==null)return;const i=l.x,r=l.y-6;t.save(),t.fillStyle="#111",t.font="12px Arial",t.textAlign="center",t.fillText(Number(s).toFixed(2),i,r),t.restore()})})}};let K=[],b={};function k(e){const t=document.getElementById(e);if(!t)return;const n=Chart.getChart(t);n&&n.destroy()}function _(e){return Object.entries(e||{}).map(([t,n])=>({label:t,value:n}))}function p(e,t,n){const o={};return(e||[]).forEach(l=>{const a=l[t]||"Lainnya";o[a]=(o[a]||0)+(Number(l[n])||0)}),Object.entries(o).map(([l,a])=>({label:l,value:a}))}function y(e,t){const n={};return(e||[]).forEach(o=>{let l=o[t];l==null||l===""||(n[l]=(n[l]||0)+1)}),n}function j(e){const t=[Number(e.asal_count)||0,Number(e.media_count)||0,Number(e.acara_count)||0,Number(e.usia_count)||0].filter(o=>isFinite(o)&&o>0);let n=0;return t.length&&(n=Math.max(...t)),n||(n=1),n}function U(e){const t=["avg_food_quality","avg_beverage_quality","avg_serving_speed","avg_service","avg_cleanliness","avg_ambience","avg_price"],n=Array.from({length:12},(o,l)=>{const a={},s={};return t.forEach(i=>{a[i]=0,s[i]=0}),{bulan:l+1,sums:a,weights:s}});return(e||[]).forEach(o=>{const l=Number(o.bulan);if(!Number.isInteger(l)||l<1||l>12)return;const a=l-1,s=j(o);t.forEach(i=>{const r=o[i];if(r==null||r==="")return;const c=Number(r);isFinite(c)&&(n[a].sums[i]+=c*s,n[a].weights[i]+=s)})}),n.map(o=>{const l={bulan:o.bulan};return Object.keys(o.sums).forEach(a=>{const s=o.weights[a];if(s&&s>0){let i=o.sums[a]/s;isFinite(i)?(i=Math.min(5,Math.max(0,i)),l[a]=Math.round(i*100)/100):l[a]=null}else l[a]=null}),l})}function $(e){const t=["avg_food_quality","avg_beverage_quality","avg_serving_speed","avg_service","avg_cleanliness","avg_ambience","avg_price"],n=Object.fromEntries(t.map(a=>[a,0])),o=Object.fromEntries(t.map(a=>[a,0]));(e||[]).forEach(a=>{const s=j(a);t.forEach(i=>{const r=a[i];if(r==null||r==="")return;const c=Number(r);isFinite(c)&&(n[i]+=c*s,o[i]+=s)})});const l={};return t.forEach(a=>{l[a]=o[a]>0?Math.round(n[a]/o[a]*100)/100:null}),l}function u(e,t,n){k(e);const o=document.getElementById(e);if(!o)return null;const l=(n||[]).map(i=>i.label),a=(n||[]).map(i=>i.value),s={type:"pie",data:{labels:l,datasets:[{data:a,backgroundColor:w.slice(0,a.length)}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:40,bottom:40,left:50,right:50}},plugins:{legend:{display:!1},title:{display:!1,text:t}}},plugins:[Y]};return new Chart(o,s)}function M(e,t){k(e);const n=document.getElementById(e);if(!n)return null;const o=["Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price"],l=[t.avg_food_quality??0,t.avg_beverage_quality??0,t.avg_serving_speed??0,t.avg_service??0,t.avg_cleanliness??0,t.avg_ambience??0,t.avg_price??0],a={type:"bar",data:{labels:o,datasets:[{label:"Average",data:l,backgroundColor:w.slice(0,o.length),barPercentage:1,categoryPercentage:.8}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:10},plugins:{legend:{display:!1},tooltip:{enabled:!0}},scales:{y:{min:0,max:5,ticks:{stepSize:1}},x:{grid:{display:!1}}}},plugins:[G]};return new Chart(n,a)}function d(e,t,n){b[e]&&(b[e].destroy(),delete b[e]);const o=document.getElementById(e);if(!o)return null;const l=(t||Array.from({length:12},()=>({}))).map(i=>{const r=i[n.field];if(r==null||r==="")return null;const c=Number(r);return Number.isFinite(c)?c:null}),a={id:"pointLabelPlugin",afterDatasetsDraw(i){const{ctx:r}=i;i.data.datasets.forEach((c,g)=>{i.getDatasetMeta(g).data.forEach((m,f)=>{const v=c.data[f];v!=null&&(r.save(),r.fillStyle="#111",r.font="11px Arial",r.textAlign="center",r.fillText(v.toFixed(2),m.x,m.y-8),r.restore())})})}},s=new Chart(o,{type:"line",data:{labels:O,datasets:[{label:n.label,data:l,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.12)",fill:!1,spanGaps:!1,tension:.25,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,elements:{line:{borderWidth:2}},plugins:{legend:{display:!1},title:{display:!0,text:n.label},tooltip:{callbacks:{label:function(i){return i.raw===null?"N/A":i.raw}}}},scales:{y:{min:0,max:5,ticks:{stepSize:1}},x:{grid:{display:!1}}}},plugins:[a]});return b[e]=s,s}async function H(){try{const e=await h.from("v_feedback_report").select("tahun").order("tahun",{ascending:!1}),t=document.getElementById("tahun");t.innerHTML="";const n=new Date().getFullYear();if(!e||e.error||!e.data||e.data.length===0){const l=document.createElement("option");l.value=n,l.textContent=n,t.appendChild(l),t.value=n;return}const o=[...new Set(e.data.map(l=>l.tahun))];o.includes(n)||o.unshift(n),o.forEach(l=>{const a=document.createElement("option");a.value=l,a.textContent=l,t.appendChild(a)}),t.value=n}catch(e){console.warn("loadTahun error:",e);const t=document.getElementById("tahun"),n=new Date().getFullYear();t.innerHTML=`<option value="${n}">${n}</option>`,t.value=n}}function R(){const e=new Date,t=e.getFullYear(),n=e.getMonth()+1,o=document.getElementById("tahun");if(o){if(!Array.from(o.options).some(s=>Number(s.value)===t)){const s=document.createElement("option");s.value=t,s.textContent=t,o.insertBefore(s,o.firstChild)}o.value=t}const l=document.getElementById("bulan");l&&(l.value=n)}function S(e){const t=document.getElementById("tahun"),n=document.getElementById("bulan");t&&(t.disabled=e),n&&(n.disabled=e)}function q(){const e=document.getElementById("startDate").value,t=document.getElementById("endDate").value;if(e&&t&&e>t){alert("Tanggal awal tidak boleh lebih besar dari tanggal akhir!"),document.getElementById("endDate").value="";return}S(!!(e||t))}function V(){R();const e=document.getElementById("startDate"),t=document.getElementById("endDate");e&&(e.value=""),t&&(t.value=""),S(!1),D()}async function D(){const e=document.getElementById("tahun").value,t=document.getElementById("bulan").value,n=document.getElementById("startDate").value,o=document.getElementById("endDate").value;try{let l=[];if(n&&o){const a=await h.from("guest_comments").select("*").gte("tgl",n).lte("tgl",o);if(a.error){console.error("loadReport error:",a.error),alert("Gagal mengambil data berdasarkan tanggal!");return}l=J(a.data)}else{let a=h.from("v_feedback_report").select("*");e&&(a=a.eq("tahun",e)),t&&(a=a.eq("bulan",t));const s=await a;if(s.error){console.error("loadReport error:",s.error),alert("Gagal mengambil data laporan!");return}l=s.data||[]}W(l)}catch(l){console.error("loadReport exception:",l)}}function J(e){if(!e||e.length===0)return[];const t=n=>e.reduce((o,l)=>o+(Number(l[n])||0),0)/e.length;return[{asal:null,asal_count:y(e,"asal"),kunjungan_pertama:null,kunjungan_count:y(e,"kunjungan_pertama"),media_source:null,media_count:y(e,"media_source"),event_type:null,acara_count:y(e,"event_type"),age_range:null,usia_count:y(e,"age_range"),avg_food_quality:t("food_quality"),avg_beverage_quality:t("beverage_quality"),avg_serving_speed:t("serving_speed"),avg_service:t("service_rating"),avg_cleanliness:t("cleanliness"),avg_ambience:t("ambience"),avg_price:t("price_rating")}]}function W(e){if(!e||e.length===0||e.length===1&&Object.keys(e[0]).length===0){["pieAsal","pieKunjungan","pieMedia","pieAcara","pieUsia","barRating"].forEach(k);return}let t,n,o,l,a;if(e.length===1&&typeof e[0].asal_count=="object"){t=_(e[0].asal_count||{}),n=_(e[0].kunjungan_count||{}),o=_(e[0].media_count||{}),l=_(e[0].acara_count||{}),a=_(e[0].usia_count||{});const s={avg_food_quality:e[0].avg_food_quality??null,avg_beverage_quality:e[0].avg_beverage_quality??null,avg_serving_speed:e[0].avg_serving_speed??null,avg_service:e[0].avg_service??null,avg_cleanliness:e[0].avg_cleanliness??null,avg_ambience:e[0].avg_ambience??null,avg_price:e[0].avg_price??null};u("pieAsal","Asal",t),u("pieKunjungan","Kunjungan Pertama",n),u("pieMedia","Media Sosial",o),u("pieAcara","Acara",l),u("pieUsia","Usia",a),M("barRating",s)}else{t=p(e,"asal","asal_count"),n=p(e,"kunjungan_pertama","kunjungan_count"),o=p(e,"media_source","media_count"),l=p(e,"event_type","acara_count"),a=p(e,"age_range","usia_count"),u("pieAsal","Asal",t),u("pieKunjungan","Kunjungan Pertama",n),u("pieMedia","Media Sosial",o),u("pieAcara","Acara",l),u("pieUsia","Usia",a);const s=$(e),i={avg_food_quality:s.avg_food_quality??null,avg_beverage_quality:s.avg_beverage_quality??null,avg_serving_speed:s.avg_serving_speed??null,avg_service:s.avg_service??null,avg_cleanliness:s.avg_cleanliness??null,avg_ambience:s.avg_ambience??null,avg_price:s.avg_price??null};M("barRating",i)}}async function z(){const e=document.getElementById("tahun").value||new Date().getFullYear();try{const t=await h.from("v_feedback_report").select("bulan, avg_food_quality, avg_beverage_quality, avg_serving_speed, avg_service, avg_cleanliness, avg_ambience, avg_price, asal_count, media_count, acara_count, usia_count").eq("tahun",e).order("bulan",{ascending:!0});if(t.error){console.error("Gagal ambil data YTD:",t.error),alert("Gagal mengambil data YTD. Cek console.");return}const n=U(t.data||[]);K=n,console.debug("[YTD] monthly aggregated:",n);const o=document.getElementById("mainCharts"),l=document.getElementById("ytdSection"),a=document.getElementById("lineChartsContainer");o&&(o.style.display="none"),l&&(l.style.display="block"),a&&(a.style.display="grid"),d("chart_food",n,{label:"",field:"avg_food_quality"}),d("chart_beverage",n,{label:"",field:"avg_beverage_quality"}),d("chart_speed",n,{label:"",field:"avg_serving_speed"}),d("chart_service",n,{label:"",field:"avg_service"}),d("chart_cleanliness",n,{label:"",field:"avg_cleanliness"}),d("chart_ambience",n,{label:"",field:"avg_ambience"}),d("chart_price",n,{label:"",field:"avg_price"})}catch(t){console.error("showYTD exception:",t)}}document.addEventListener("DOMContentLoaded",async()=>{await H(),R(),await D();const e=document.getElementById("btnProses"),t=document.getElementById("btnReset"),n=document.getElementById("startDate"),o=document.getElementById("endDate"),l=document.getElementById("btnBack");e&&e.addEventListener("click",D),t&&t.addEventListener("click",V),n&&n.addEventListener("change",q),o&&o.addEventListener("change",q),l&&l.addEventListener("click",()=>{const s=document.getElementById("mainCharts"),i=document.getElementById("ytdSection");i&&(i.style.display="none"),s&&(s.style.display="block",s.scrollIntoView({behavior:"smooth",block:"start"}))});const a=document.getElementById("barRating");a&&a.addEventListener("click",async()=>{const s=document.getElementById("mainCharts"),i=document.getElementById("ytdSection");s&&(s.style.display="none"),i&&(i.style.display="flex",await z(),i.scrollIntoView({behavior:"smooth",block:"start"}))})});
