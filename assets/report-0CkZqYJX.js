import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{c as N,l as P,s as h}from"./base-B22LZU_k.js";import"https://esm.sh/@supabase/supabase-js";N();document.getElementById("logout").onclick=P;const w=["#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ac"],O=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],Y={id:"outlabelsPlugin",afterDraw(t){if(t.config.type!=="pie"&&t.config.type!=="doughnut")return;const e=t.ctx,n=t.data.datasets[0]||{data:[]},o=t.getDatasetMeta(0),l=(n.data||[]).reduce((a,s)=>a+(s||0),0);!o||!o.data||o.data.forEach((a,s)=>{const i=n.data[s]||0;if(i===0)return;const r=a.startAngle,c=a.endAngle,g=(r+c)/2,E=a.x,f=a.y,m=a.outerRadius||Math.min(t.width,t.height)/2,v=E+Math.cos(g)*(m*.9),L=f+Math.sin(g)*(m*.9),x=E+Math.cos(g)*(m+18),B=f+Math.sin(g)*(m+18),I=Math.cos(g)>=0,A=x+(I?8:-8),C=B+4;e.save(),e.strokeStyle="#333",e.lineWidth=1,e.beginPath(),e.moveTo(v,L),e.lineTo(x,B),e.stroke(),e.fillStyle="#333",e.beginPath(),e.arc(x,B,2.5,0,Math.PI*2),e.fill();const T=t.data.labels[s]??"Lainnya",F=l?(i/l*100).toFixed(1):"0.0";e.font="12px Arial",e.fillStyle="#111",e.textAlign=I?"left":"right",e.fillText(`${T} â€” ${i}`,A,C),e.fillText(`(${F}%)`,A,C+14),e.restore()})}},G={id:"barLabelPlugin",afterDatasetsDraw(t){if(t.config.type!=="bar")return;const e=t.ctx;t.data.datasets.forEach(n=>{t.getDatasetMeta(0).data.forEach((l,a)=>{const s=n.data[a];if(s==null)return;const i=l.x,r=l.y-6;e.save(),e.fillStyle="#111",e.font="12px Arial",e.textAlign="center",e.fillText(Number(s).toFixed(2),i,r),e.restore()})})}};let K=[],b={};function k(t){const e=document.getElementById(t);if(!e)return;const n=Chart.getChart(e);n&&n.destroy()}function _(t){return Object.entries(t||{}).map(([e,n])=>({label:e,value:n}))}function p(t,e,n){const o={};return(t||[]).forEach(l=>{const a=l[e]||"Lainnya";o[a]=(o[a]||0)+(Number(l[n])||0)}),Object.entries(o).map(([l,a])=>({label:l,value:a}))}function y(t,e){const n={};return(t||[]).forEach(o=>{const l=o[e]||"Lainnya";n[l]=(n[l]||0)+1}),n}function j(t){const e=[Number(t.asal_count)||0,Number(t.media_count)||0,Number(t.acara_count)||0,Number(t.usia_count)||0].filter(o=>isFinite(o)&&o>0);let n=0;return e.length&&(n=Math.max(...e)),n||(n=1),n}function U(t){const e=["avg_food_quality","avg_beverage_quality","avg_serving_speed","avg_service","avg_cleanliness","avg_ambience","avg_price"],n=Array.from({length:12},(o,l)=>{const a={},s={};return e.forEach(i=>{a[i]=0,s[i]=0}),{bulan:l+1,sums:a,weights:s}});return(t||[]).forEach(o=>{const l=Number(o.bulan);if(!Number.isInteger(l)||l<1||l>12)return;const a=l-1,s=j(o);e.forEach(i=>{const r=o[i];if(r==null||r==="")return;const c=Number(r);isFinite(c)&&(n[a].sums[i]+=c*s,n[a].weights[i]+=s)})}),n.map(o=>{const l={bulan:o.bulan};return Object.keys(o.sums).forEach(a=>{const s=o.weights[a];if(s&&s>0){let i=o.sums[a]/s;isFinite(i)?(i=Math.min(5,Math.max(0,i)),l[a]=Math.round(i*100)/100):l[a]=null}else l[a]=null}),l})}function $(t){const e=["avg_food_quality","avg_beverage_quality","avg_serving_speed","avg_service","avg_cleanliness","avg_ambience","avg_price"],n=Object.fromEntries(e.map(a=>[a,0])),o=Object.fromEntries(e.map(a=>[a,0]));(t||[]).forEach(a=>{const s=j(a);e.forEach(i=>{const r=a[i];if(r==null||r==="")return;const c=Number(r);isFinite(c)&&(n[i]+=c*s,o[i]+=s)})});const l={};return e.forEach(a=>{l[a]=o[a]>0?Math.round(n[a]/o[a]*100)/100:null}),l}function u(t,e,n){k(t);const o=document.getElementById(t);if(!o)return null;const l=(n||[]).map(i=>i.label),a=(n||[]).map(i=>i.value),s={type:"pie",data:{labels:l,datasets:[{data:a,backgroundColor:w.slice(0,a.length)}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:40,bottom:40,left:50,right:50}},plugins:{legend:{display:!1},title:{display:!1,text:e}}},plugins:[Y]};return new Chart(o,s)}function M(t,e){k(t);const n=document.getElementById(t);if(!n)return null;const o=["Food Quality","Beverage Quality","Serving Speed","Service","Cleanliness","Ambience","Price"],l=[e.avg_food_quality??0,e.avg_beverage_quality??0,e.avg_serving_speed??0,e.avg_service??0,e.avg_cleanliness??0,e.avg_ambience??0,e.avg_price??0],a={type:"bar",data:{labels:o,datasets:[{label:"Average",data:l,backgroundColor:w.slice(0,o.length),barPercentage:1,categoryPercentage:.8}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:10},plugins:{legend:{display:!1},tooltip:{enabled:!0}},scales:{y:{min:0,max:5,ticks:{stepSize:1}},x:{grid:{display:!1}}}},plugins:[G]};return new Chart(n,a)}function d(t,e,n){b[t]&&(b[t].destroy(),delete b[t]);const o=document.getElementById(t);if(!o)return null;const l=(e||Array.from({length:12},()=>({}))).map(i=>{const r=i[n.field];if(r==null||r==="")return null;const c=Number(r);return Number.isFinite(c)?c:null}),a={id:"pointLabelPlugin",afterDatasetsDraw(i){const{ctx:r}=i;i.data.datasets.forEach((c,g)=>{i.getDatasetMeta(g).data.forEach((f,m)=>{const v=c.data[m];v!=null&&(r.save(),r.fillStyle="#111",r.font="11px Arial",r.textAlign="center",r.fillText(v.toFixed(2),f.x,f.y-8),r.restore())})})}},s=new Chart(o,{type:"line",data:{labels:O,datasets:[{label:n.label,data:l,borderColor:"#4e79a7",backgroundColor:"rgba(78,121,167,0.12)",fill:!1,spanGaps:!1,tension:.25,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,elements:{line:{borderWidth:2}},plugins:{legend:{display:!1},title:{display:!0,text:n.label},tooltip:{callbacks:{label:function(i){return i.raw===null?"N/A":i.raw}}}},scales:{y:{min:0,max:5,ticks:{stepSize:1}},x:{grid:{display:!1}}}},plugins:[a]});return b[t]=s,s}async function H(){try{const t=await h.from("v_feedback_report").select("tahun").order("tahun",{ascending:!1}),e=document.getElementById("tahun");e.innerHTML="";const n=new Date().getFullYear();if(!t||t.error||!t.data||t.data.length===0){const l=document.createElement("option");l.value=n,l.textContent=n,e.appendChild(l),e.value=n;return}const o=[...new Set(t.data.map(l=>l.tahun))];o.includes(n)||o.unshift(n),o.forEach(l=>{const a=document.createElement("option");a.value=l,a.textContent=l,e.appendChild(a)}),e.value=n}catch(t){console.warn("loadTahun error:",t);const e=document.getElementById("tahun"),n=new Date().getFullYear();e.innerHTML=`<option value="${n}">${n}</option>`,e.value=n}}function R(){const t=new Date,e=t.getFullYear(),n=t.getMonth()+1,o=document.getElementById("tahun");if(o){if(!Array.from(o.options).some(s=>Number(s.value)===e)){const s=document.createElement("option");s.value=e,s.textContent=e,o.insertBefore(s,o.firstChild)}o.value=e}const l=document.getElementById("bulan");l&&(l.value=n)}function S(t){const e=document.getElementById("tahun"),n=document.getElementById("bulan");e&&(e.disabled=t),n&&(n.disabled=t)}function q(){const t=document.getElementById("startDate").value,e=document.getElementById("endDate").value;if(t&&e&&t>e){alert("Tanggal awal tidak boleh lebih besar dari tanggal akhir!"),document.getElementById("endDate").value="";return}S(!!(t||e))}function V(){R();const t=document.getElementById("startDate"),e=document.getElementById("endDate");t&&(t.value=""),e&&(e.value=""),S(!1),D()}async function D(){const t=document.getElementById("tahun").value,e=document.getElementById("bulan").value,n=document.getElementById("startDate").value,o=document.getElementById("endDate").value;try{let l=[];if(n&&o){const a=await h.from("guest_comments").select("*").gte("tgl",n).lte("tgl",o);if(a.error){console.error("loadReport error:",a.error),alert("Gagal mengambil data berdasarkan tanggal!");return}l=J(a.data)}else{let a=h.from("v_feedback_report").select("*");t&&(a=a.eq("tahun",t)),e&&(a=a.eq("bulan",e));const s=await a;if(s.error){console.error("loadReport error:",s.error),alert("Gagal mengambil data laporan!");return}l=s.data||[]}W(l)}catch(l){console.error("loadReport exception:",l)}}function J(t){if(!t||t.length===0)return[];const e=n=>t.reduce((o,l)=>o+(Number(l[n])||0),0)/t.length;return[{asal:null,asal_count:y(t,"asal"),kunjungan_pertama:null,kunjungan_count:y(t,"kunjungan_pertama"),media_source:null,media_count:y(t,"media_source"),event_type:null,acara_count:y(t,"event_type"),age_range:null,usia_count:y(t,"age_range"),avg_food_quality:e("food_quality"),avg_beverage_quality:e("beverage_quality"),avg_serving_speed:e("serving_speed"),avg_service:e("service_rating"),avg_cleanliness:e("cleanliness"),avg_ambience:e("ambience"),avg_price:e("price_rating")}]}function W(t){if(!t||t.length===0){["pieAsal","pieKunjungan","pieMedia","pieAcara","pieUsia","barRating"].forEach(s=>k(s));return}let e,n,o,l,a;if(t.length===1&&typeof t[0].asal_count=="object"){e=_(t[0].asal_count),n=_(t[0].kunjungan_count),o=_(t[0].media_count),l=_(t[0].acara_count),a=_(t[0].usia_count);const s={avg_food_quality:t[0].avg_food_quality??null,avg_beverage_quality:t[0].avg_beverage_quality??null,avg_serving_speed:t[0].avg_serving_speed??null,avg_service:t[0].avg_service??null,avg_cleanliness:t[0].avg_cleanliness??null,avg_ambience:t[0].avg_ambience??null,avg_price:t[0].avg_price??null};u("pieAsal","Asal",e),u("pieKunjungan","Kunjungan Pertama",n),u("pieMedia","Media Sosial",o),u("pieAcara","Acara",l),u("pieUsia","Usia",a),M("barRating",s)}else{e=p(t,"asal","asal_count"),n=p(t,"kunjungan_pertama","kunjungan_count"),o=p(t,"media_source","media_count"),l=p(t,"event_type","acara_count"),a=p(t,"age_range","usia_count"),u("pieAsal","Asal",e),u("pieKunjungan","Kunjungan Pertama",n),u("pieMedia","Media Sosial",o),u("pieAcara","Acara",l),u("pieUsia","Usia",a);const s=$(t),i={avg_food_quality:s.avg_food_quality??null,avg_beverage_quality:s.avg_beverage_quality??null,avg_serving_speed:s.avg_serving_speed??null,avg_service:s.avg_service??null,avg_cleanliness:s.avg_cleanliness??null,avg_ambience:s.avg_ambience??null,avg_price:s.avg_price??null};M("barRating",i)}}async function z(){const t=document.getElementById("tahun").value||new Date().getFullYear();try{const e=await h.from("v_feedback_report").select("bulan, avg_food_quality, avg_beverage_quality, avg_serving_speed, avg_service, avg_cleanliness, avg_ambience, avg_price, asal_count, media_count, acara_count, usia_count").eq("tahun",t).order("bulan",{ascending:!0});if(e.error){console.error("Gagal ambil data YTD:",e.error),alert("Gagal mengambil data YTD. Cek console.");return}const n=U(e.data||[]);K=n,console.debug("[YTD] monthly aggregated:",n);const o=document.getElementById("mainCharts"),l=document.getElementById("ytdSection"),a=document.getElementById("lineChartsContainer");o&&(o.style.display="none"),l&&(l.style.display="block"),a&&(a.style.display="grid"),d("chart_food",n,{label:"",field:"avg_food_quality"}),d("chart_beverage",n,{label:"",field:"avg_beverage_quality"}),d("chart_speed",n,{label:"",field:"avg_serving_speed"}),d("chart_service",n,{label:"",field:"avg_service"}),d("chart_cleanliness",n,{label:"",field:"avg_cleanliness"}),d("chart_ambience",n,{label:"",field:"avg_ambience"}),d("chart_price",n,{label:"",field:"avg_price"})}catch(e){console.error("showYTD exception:",e)}}document.addEventListener("DOMContentLoaded",async()=>{await H(),R(),await D();const t=document.getElementById("btnProses"),e=document.getElementById("btnReset"),n=document.getElementById("startDate"),o=document.getElementById("endDate"),l=document.getElementById("btnBack");t&&t.addEventListener("click",D),e&&e.addEventListener("click",V),n&&n.addEventListener("change",q),o&&o.addEventListener("change",q),l&&l.addEventListener("click",()=>{const s=document.getElementById("mainCharts"),i=document.getElementById("ytdSection");i&&(i.style.display="none"),s&&(s.style.display="block",s.scrollIntoView({behavior:"smooth",block:"start"}))});const a=document.getElementById("barRating");a&&a.addEventListener("click",async()=>{const s=document.getElementById("mainCharts"),i=document.getElementById("ytdSection");s&&(s.style.display="none"),i&&(i.style.display="flex",await z(),i.scrollIntoView({behavior:"smooth",block:"start"}))})});
